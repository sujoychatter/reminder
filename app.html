<html>
	<head>
		<style>
			#off-tim.saved #save-btn{
					display: none;
			}
		</style>
	</head>
	<body>
		<h1>
			Reminder Application
		</h1>
		<div id="off-tim">
			<p>
				Office timings:
			</p>
			<span>
				Start time:
			</span>
			<select id="start-timing">
				<option value="0">00:00</option>
				<option value="1">01:00</option>
				<option value="2">02:00</option>
				<option value="3">03:00</option>
				<option value="4">04:00</option>
				<option value="5">05:00</option>
				<option value="6">06:00</option>
				<option value="7">07:00</option>
				<option value="8">08:00</option>
				<option value="9">09:00</option>
				<option value="10">10:00</option>
				<option value="11">11:00</option>
				<option value="12">12:00</option>
				<option value="13">13:00</option>
				<option value="14">14:00</option>
				<option value="15">15:00</option>
				<option value="16">16:00</option>
				<option value="17">17:00</option>
				<option value="18">18:00</option>
				<option value="19">19:00</option>
				<option value="20">20:00</option>
				<option value="21">21:00</option>
				<option value="22">22:00</option>
				<option value="23">23:00</option>
			</select>
			<span>
				End time:
			</span>
			<select id="end-timing">
				<option value="0">00:00</option>
				<option value="1">01:00</option>
				<option value="2">02:00</option>
				<option value="3">03:00</option>
				<option value="4">04:00</option>
				<option value="5">05:00</option>
				<option value="6">06:00</option>
				<option value="7">07:00</option>
				<option value="8">08:00</option>
				<option value="9">09:00</option>
				<option value="10">10:00</option>
				<option value="11">11:00</option>
				<option value="12">12:00</option>
				<option value="13">13:00</option>
				<option value="14">14:00</option>
				<option value="15">15:00</option>
				<option value="16">16:00</option>
				<option value="17">17:00</option>
				<option value="18">18:00</option>
				<option value="19">19:00</option>
				<option value="20">20:00</option>
				<option value="21">21:00</option>
				<option value="22">22:00</option>
				<option value="23">23:00</option>
			</select>
			<button id="save-btn" onclick="reminder_app.saveTimings()">Save</button>
		</div>
		<div id="reminder">
			<h2>New reminder</h2>
			<span>Reminder after</span>
			<input id="reminder-hrs" type="text" />
			<span>hours</span>
			<textarea id="reminder-text" placeholder="Enter reminder text"></textarea>
			<button id="save-reminder" onclick="reminder_app.saveReminder()">Save</button>
		</div>
		<script>
			reminder_app = {
				checkStorage : function(){
					return typeof(Storage) !== "undefined"
				},
				validateTimings: function(start, end){
					return(start < end);
				},
				store: {
					saveData: function(type){
						return reminder_app.store[type].apply(reminder_app, Array.prototype.slice.call(arguments, 1));
					},
					timingsSet: function(startTime, endTime){
						localStorage.setItem("reminder_app_data", JSON.stringify({timings  : {start_time: startTime, end_time: endTime}}));
						reminder_app.disableElements([document.getElementById('start-timing'), document.getElementById('end-timing')]);
						document.getElementById('off-tim').classList.add("saved");
					},
					reminderSet: function(reminder){
						var storeData = JSON.parse(localStorage.getItem("reminder_app_data")),
							reminders = storeData.reminders,
							stored_index;
						if(reminders){
							stored_index = reminder_app.store.helpers.pushReminder(reminder, reminders);
						}
						else{
							storeData.reminders = [reminder];
							stored_index = 0;
						}
						localStorage.setItem("reminder_app_data", JSON.stringify(storeData));
						return stored_index;
					},
					helpers: {
						pushReminder: function(new_reminder, reminders){
							var i=0, reminders_length = reminders.length;
							while(new Date(reminders[i].trigger_date) < new Date(new_reminder.trigger_date)){
								if(++i == reminders_length){
									break;
								}
							}
							reminders.splice(i, 0, new_reminder);
							return i;
						}
					}
				},
				saveTimings: function(){
					startTiming = parseInt(document.getElementById('start-timing').value);
					endTiming = parseInt(document.getElementById('end-timing').value);
					if(reminder_app.validateTimings(startTiming, endTiming))
					{
						reminder_app.store.saveData("timingsSet", startTiming, endTiming);
					}
					else{
						alert("Start time should be before end time");
					}
				},
				validateReminder: function(time){
					storageData = localStorage.getItem("reminder_app_data");
					timeIsNum = !isNaN(time);
					if(!storageData){
						alert("Please set office timings first");
					}
					else if(!timeIsNum){
						alert("Please enter valid hours");	
					}
					return (storageData && timeIsNum);
				},
				saveReminder: function(){
					var wait_time = parseInt(document.getElementById('reminder-hrs').value)*60*60*1000;
					if(reminder_app.validateReminder(wait_time)){
						var todayEOD = new Date();
						todayEOD.setHours(JSON.parse(localStorage.getItem("reminder_app_data"))["timings"]["end_time"])
						todayEOD.setMinutes(0);
						todayEOD.setSeconds(0);
						var todaySOD = new Date();
						todaySOD.setHours(JSON.parse(localStorage.getItem("reminder_app_data"))["timings"]["start_time"])
						todaySOD.setMinutes(0);
						todaySOD.setSeconds(0);
						var now = new Date(),
						offset = 0,
						triggerDate,
						workingInterval = todayEOD - todaySOD,
						timeLeft, add24hours, end_offset;
						if(todaySOD < now && now < todayEOD){
							offset = todayEOD - now;
						}
						else if(now < todaySOD){
							offset = todayEOD - todaySOD;
							now = todaySOD;
						}
						if(offset > wait_time){
							triggerDate = new Date(now.getTime() + wait_time);
						}
						else{
							nextDayOffset = 24*60*60*1000 - workingInterval;
							timeLeft = wait_time - offset;
							add24hours = Math.floor(timeLeft/workingInterval);
							end_offset = timeLeft%workingInterval;
							triggerDate = new Date(now.getTime() + offset + nextDayOffset + add24hours*24*60*60*1000 + end_offset)
						}
						var reminderObj= {
								trigger_date: triggerDate,
								message: document.getElementById("reminder-text").value
							},
							storedIndex;
						storedIndex = reminder_app.store.saveData("reminderSet", reminderObj);
						if(storedIndex == 0){
							reminder_app.initiateTimeout()
						}
						alert("reminder time: " + triggerDate, storedIndex);
					}
				},
				initiateTimeout: function(){
					//remote prev timeout
					//iterate to find < now reminders, show error
					// first > now reminder set timeout

					//call this function on app init, new remider added and reminder timeout callback
				},
				disableElements: function(elements){
					elements.forEach(function(ele){
						ele.setAttribute("disabled", true);
					})
				},
				setInitialData: function(storeData){
					var startElement = document.getElementById('start-timing');
					var endElement = document.getElementById('end-timing');

					startElement.value = storeData.timings.start_time;
					endElement.value = storeData.timings.end_time;

					this.disableElements([startElement, endElement]);
					document.getElementById('off-tim').classList.add("saved");
				},
				init : function(){
					if(this.checkStorage()){
						var storageData = JSON.parse(localStorage.getItem("reminder_app_data"));
						if(storageData){
							this.setInitialData(storageData)
						}
					}
					else{
						alert('Sorry, this app is not suported in this browser');
					}
				}
			}
			window.onload = reminder_app.init.bind(reminder_app);
		</script>
	</body>
</html>